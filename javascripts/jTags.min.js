(function($){window.jTagSettings={execAllAfterJend:true,scopeSelector:"html"};$.fn.exec=function(){if(this.length==0)$(this).jTagError("cannot execute non-existing jTag");var e=$(this).first();var t=e.skip();if(!isNaN(t)){e.skip(t-1);$(e).trigger("skip");return"skip"}else if(t==="true"){$(e).trigger("skip");return"skip"}var n=e.prop("tagName").toLowerCase();var r={};var i=e.get(0).attributes;for(var s=0,o=i.length;s<o;s++)r[i[s].name]=i[s].value;var u=$.extend(e.data("jTagData"),r);var a=jTags[n];if($.isFunction(a)){e.trigger("beforeExec",u);a.call(e,u);e.attr("skip","true");$(window).trigger("afterExec",[n,u])}else $(e).jTagError("jTag `"+n+"` not found")};$.fn.execLayer=function(){var e=this;$(e).trigger("beforeExecLayer");var t="";for(var n in jTags){if(jTags.hasOwnProperty(n)){t+=n+","}}t=t.substr(0,t.length-1);$(e).find(t).each(function(e,n){if($(n).parents(t).length==0)$(n).exec()});$(e).trigger("beforeExecLayer")};$.fn.execAll=function(){var e=this;$(e).trigger("beforeExecAll");var t="",n="a";while(t!==n){t=$(e).html();$(e).execLayer();n=$(e).html()}$(e).trigger("afterExecAll")};$.fn.jend=function(e){var t=this;var n=$(t).prop("tagName").toLowerCase();$(t).trigger("beforeJend",e);if(typeof e!=="undefined")$(t).html("").append(e);$(t).replaceWith($(t).contents());$(window).trigger("afterJend",[n,e]);if(jTagSettings.execAllAfterJend)$(jTagSettings.scopeSelector).execAll()};$.fn.skip=function(e){var t=this;if(e){if(e==0)$(t).removeAttr("skip");else if(e=="once")$(t).attr("skip",1);else if(!isNaN(e))$(t).attr("skip",e);else if(e=="true")$(t).attr("skip","true");else $(t).jTagError("invalid value of `skip` attribute")}else return $(t).attr("skip")};$.fn.jTagError=function(e){var t={name:"jTags Error",jTag:this,message:e,htmlMessage:e,toString:function(){return this.name+": "+this.message}};throw t};window.jTags={"new-jtag":function(data){function newJtag(){try{F=eval("["+F.trim()+"]")[0]}catch(er){$(e).jTagError("new-jtag: invalid function definition:"+er)}jTags[data.name]=F;$(e).jend("")}var e=this;var F="";if(typeof data.name==="undefined")$(e).jTagError("new-jtag: name not defined");if(data.source){$.get(data.source).done(function(e){F=e;newJtag()}).fail(function(){$(e).jTagError("new-jtag: failed retreiving function via $.get ("+data.source+")")})}else{F=$(e).html();newJtag()}},jtag:function(data){try{eval(data.code)}catch(e){$(this).jTagError("jTag: failed executing code")}},load:function(e){var t=this;if(e.action)$.get(e.action).done(function(e){$(t).jend(e)}).fail(function(){$(t).jTagError("load: failed loading content: "+e.action)})},"define-fragment":function(e){function r(){n=$(t).contents().clone(true);window.fragments[e.name]=n;$(t).jend("")}if(!e.name)$(this).jTagError("define-fragment: no name is specified");var t=this;var n="";if(!window.fragments)window.fragments={};if(e.source){$.get(e.source).done(function(e){$(t).html(e);r()}).fail(function(){$(this).jTagError("define-fragment: failed to retreive content via $.get ("+e.source+")")})}else r()},fragment:function(e){function n(){$(t).html("").append(window.fragments[e.name].clone(true));var n=/{%(\w+) *(\[(?:.|\r|\n)*?\])? *%}/gmi;$(t).textCrawl(n,function(t,n){for(var r in n){var i=n[r];var s="error: no value could be found for parameter: `"+i[1]+"`";if(i[2])s=i[2].substr(1,i[2].length-2);if(e[i[1].toLowerCase()])s=e[i[1].toLowerCase()];t=t.replace(i[0],s)}return t});$(t).jend()}if(!e.name){$(this).jTagError("fragment: no name is specified")}if(!window.fragments||!window.fragments[e.name]){$(this).skip("once");return}var t=this;if(e.source){$.getJSON(e.source).done(function(t){e=$.extend(e,t);n()}).fail(function(){$(t).jTagError("fragment: falied to retreive JSON object via $.getJSON ("+e.source+")")})}else n()},repeater:function(e){function r(){var r=0;if(n)r=n.length;if(e.times)r=e.times;if(!r)$(t).jTagError("repeater: no array or no `times` attribute");var i=$(t).contents();$(t).html("");for(var s=0;s<r;s++){var o=i.clone(true);o.filter("fragment").each(function(e,t){if(n&&n[s])$(t).data("jTagData",n[s])});$(t).append(o)}$(t).jend()}var t=this;var n;if(e.source){$.getJSON(e.source).done(function(e){n=$.extend($(t).data("jTagData"),e);r()}).fail(function(){$(t).jTagError("repeater: falied to retreive JSON object via $.getJSON ("+e.source+")")})}else r()},"content-holder":function(e){if(!e.name)$(this).jTagError("content-holder: no name specified");$(this).wrap('<div id="content-holder-'+e.name+'"></div>');$(this).jend();if(urlParam("href"))ajaxBrowse(urlParam("href"),false);if(!window.bound){window.onpopstate=function(){if(urlParam("href"))ajaxBrowse(urlParam("href"),false);else $("[id^=content-holder-]").html("")};$("html").on("click","a[href]:not([rel=external])",function(e){e.preventDefault();ajaxBrowse($(this).attr("href"))});window.bound=true}}};$.fn.textCrawl=function(e,t){function u(e,t,n){var r=[],i;while(i=t.exec(e))r.push(i);if(r.length>0)return n.call(window,e,r);else return false}var n=this.get(0);for(var r=0;r<n.childNodes.length;r++){var i=n.childNodes[r];if(i.nodeType==1){for(var s=0;s<i.attributes.length;s++){var o=u(i.attributes[s].value,e,t);if(o)i.attributes[s].value=o}$(i).textCrawl(e,t)}else if(i.nodeType==3){var o=u(i.data,e,t);if(o)i.data=o}}};window.ajaxBrowse=function(e,t){var n=this;$(window).trigger("beforeAjaxBrowse",e);$.get(e,function(n){$(n).filter("content[name]").each(function(e,t){$("[id^=content-holder-"+$(t).attr("name")+"]").html("").append($(t).contents().clone(true))});if(t!==false)window.history.pushState("","",urlParam("href",e));$(window).trigger("afterAjaxBrowse",e)}).fail(function(){$(window).jTagError("ajaxBrowse: failed to retreive the page")})};window.urlParam=function(e,t){function r(e,t){if(!t)t=window.location.search;var n=new RegExp("[?|&]"+e+"=(.*?)&");var r=n.exec(t+"&");if(!r||r.length<2)return"";return decodeURIComponent(r[1].replace("+"," "))}function i(e,t,n){n=n||window.location.search;var r=n+"&";var i=new RegExp("[?|&]"+e+"=.*?&");if(!i.test(r))r+=e+"="+encodeURI(t);else r=r.replace(i,"&"+e+"="+encodeURIComponent(t)+"&");r=r.trimStart("&").trimEnd("&");return r[0]=="?"?r:r="?"+r}var n=location.search;if(!window.doneHelpers){String.prototype.trimEnd=function(e){if(e)return this.replace(new RegExp(e.escapeRegExp()+"*$"),"");return this.replace(/\s+$/,"")};String.prototype.trimStart=function(e){if(e)return this.replace(new RegExp("^"+e.escapeRegExp()+"*"),"");return this.replace(/^\s+/,"")};String.prototype.escapeRegExp=function(){return this.replace(/[.*+?^${}()|[\]\/\\]/g,"\\$0")}}window.doneHelpers=true;if(t)return i(e,t,n);else return r(e,n)}})(jQuery)